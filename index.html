<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2kgアナログはかり（単体版・針テーパー版）</title>
<style>
  :root{--ink:#0b1220; --muted:#5b6477; --brand:#2563eb; --line:#e4e9f3}
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif; background:#f6f8fb; color:var(--ink)}
  .wrap{max-width:1000px; margin:24px auto; padding:0 16px}
  h1{font-size:22px; margin:0 0 12px 0}
  .card{background:#fff; border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .row{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
  button{appearance:none; border:none; border-radius:999px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow:inset 0 0 0 1px #d6dbe6; background:#f3f5f9}
  button.primary{background:var(--brand); color:#fff; box-shadow:none}
  .shadow{box-shadow:0 2px 6px rgba(0,0,0,.12)}
  .note{font-size:12px; color:var(--muted)}
  .center{display:flex; justify-content:center}
</style>
</head>
<body>
  <div class="wrap">
    <h1>2kgアナログはかり</h1>
    <div class="card center">
      <svg id="scaleSvg" viewBox="0 0 420 420" width="420" height="420" class="shadow" role="img" aria-label="2kgアナログはかり">
        <circle cx="210" cy="210" r="208" fill="#fff" stroke="#2d6cdf" stroke-width="10"/>
        <circle cx="210" cy="210" r="190" fill="#ffffff" />
        <g id="ticks" stroke="#333"></g>
        <g id="labels" fill="#333" font-weight="700"></g>
        <g id="needle" transform="rotate(0 210 210)">
          <g id="needleHit" style="cursor: grab">
            <!-- Tapered polygon needle: wide base, narrow tip -->
            <polygon id="needlePoly" fill="#e53935" stroke="#b91c1c" stroke-width="1"/>
            <circle cx="210" cy="210" r="10" fill="#fff" stroke="#555" stroke-width="3"/>
          </g>
        </g>
      </svg>
    </div>

    <div class="row">
      <button class="primary" id="rnd10">ランダム(10g)</button>
      <button class="primary" id="rnd100">ランダム(100g)</button>
      <button id="toZero">0にもどす</button>
      <button id="toggleAns">答えを表示</button>
    </div>
    <div id="readout" style="margin-top:10px; font-weight:800">現在：???</div>
    <p class="note">針をドラッグ/スワイプで回せます。</p>
  </div>

<script>
(function(){
  const svg = document.getElementById('scaleSvg');
  const ticksGroup = document.getElementById('ticks');
  const labelsGroup = document.getElementById('labels');
  const needle = document.getElementById('needle');
  const hit = document.getElementById('needleHit');
  const needlePoly = document.getElementById('needlePoly');
  const readout = document.getElementById('readout');
  const btn10 = document.getElementById('rnd10');
  const btn100 = document.getElementById('rnd100');
  const btnZero = document.getElementById('toZero');
  const btnToggle = document.getElementById('toggleAns');

  const size = 420, r = 190, cx = 210, cy = 210;
  let grams = 0;
  let answerHidden = true;
  let dragging = false;

  function valueToAngle(g){ return (g/2000)*360; }
  function polar(radius, deg){
    const rad = ((deg - 90) * Math.PI) / 180;
    return { x: cx + radius * Math.cos(rad), y: cy + radius * Math.sin(rad) };
  }
  function clamp360(d){ return ((d%360)+360)%360; }

  // ticks
  for(let g=0; g<2000; g+=10){
    const deg = valueToAngle(g);
    const isMajor = g%200===0;
    const isMid = !isMajor && g%100===0;
    const len = isMajor?18:(isMid?12:6);
    const p1 = polar(r-6, deg);
    const p2 = polar(r-6-len, deg);
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", p1.x); line.setAttribute("y1", p1.y);
    line.setAttribute("x2", p2.x); line.setAttribute("y2", p2.y);
    line.setAttribute("stroke-width", isMajor?3:1);
    ticksGroup.appendChild(line);
  }

  // labels
  const labelPositions = [
    { value:2000, text:"2 kg", fontSize:22, weight:800 },
    { value:0, text:"0", radius:160, fontSize:16 },
    { value:200, text:"200g", fontSize:16 },
    { value:400, text:"400g", fontSize:16 },
    { value:600, text:"600g", fontSize:16 },
    { value:800, text:"800g", fontSize:16 },
    { value:1000, text:"1 kg", fontSize:18, weight:700 },
    { value:1500, text:"1 kg 500g", fontSize:16 }
  ];
  for(const lp of labelPositions){
    const deg = valueToAngle(lp.value%2000);
    const pos = polar(lp.radius ?? (r-40), deg);
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x", pos.x); t.setAttribute("y", pos.y);
    t.setAttribute("font-size", lp.fontSize ?? 16);
    t.setAttribute("font-weight", lp.weight ?? 600);
    t.setAttribute("text-anchor", "middle");
    t.setAttribute("dominant-baseline", "middle");
    t.textContent = lp.text;
    labelsGroup.appendChild(t);
  }

  function setGrams(g){
    grams = Math.max(0, Math.min(2000, Math.round(g/10)*10));
    const deg = valueToAngle(grams);
    needle.setAttribute("transform", `rotate(${deg} ${cx} ${cy})`);
    renderReadout();
  }

  function gramsToLabel(g){
    if (g % 1000 === 0) return (g/1000) + " kg";
    if (g > 1000 && g % 500 === 0) return Math.floor(g/1000) + " kg " + (g%1000) + " g";
    return g + " g";
  }

  function renderReadout(){
    readout.textContent = "現在：" + (answerHidden? "???" : gramsToLabel(grams));
    btnToggle.textContent = answerHidden? "答えを表示" : "答えを隠す";
  }

  // set needle shape (tapered)
  function updateNeedleShape(){
    const baseWidth = 14; // width at center
    const tipWidth = 2;   // width at tip
    const length = 170;   // length from center to tip

    // Polygon: two base corners, two tip corners
    const p1 = [cx - baseWidth/2, cy]; 
    const p2 = [cx + baseWidth/2, cy];
    const p3 = [cx + tipWidth/2, cy - length];
    const p4 = [cx - tipWidth/2, cy - length];

    needlePoly.setAttribute("points", [p1,p2,p3,p4].map(p=>p.join(",")).join(" "));
  }

  // drag logic
  function onPointerMove(e){
    if(!dragging) return;
    const rect = svg.getBoundingClientRect();
    const cxp = rect.left + rect.width/2;
    const cyp = rect.top + rect.height/2;
    const rad = Math.atan2(e.clientY - cyp, e.clientX - cxp);
    let deg = rad * 180 / Math.PI;
    deg = clamp360(deg + 90);
    const g = Math.round((deg/360)*2000/10)*10;
    setGrams(g);
  }
  function startDrag(e){ dragging = true; e.target.setPointerCapture?.(e.pointerId); }
  function stopDrag(){ dragging = false; }
  hit.addEventListener("pointerdown", startDrag);
  window.addEventListener("pointermove", onPointerMove);
  window.addEventListener("pointerup", stopDrag);

  // spin animation
  function spinTo(target){
    target = Math.max(0, Math.min(2000, Math.round(target/10)*10));
    const start = grams;
    const diff = ( (target - start + 2000) % 2000 );
    const backwards = 2000 - diff;
    const dir = diff <= backwards ? 10 : -10;
    const total = diff <= backwards ? diff : backwards;
    const steps = Math.max(20, Math.floor(total/10));
    const duration = 600;
    const interval = duration/steps;
    let i=0;
    const id = setInterval(()=>{
      i++;
      setGrams((grams + dir + 2000) % 2000);
      if(i>=steps){
        clearInterval(id);
        setGrams(target);
      }
    }, interval);
  }

  // buttons
  btn10.addEventListener("click", ()=> spinTo(Math.floor(Math.random()*201)*10));
  btn100.addEventListener("click", ()=> spinTo((Math.floor(Math.random()*20)+1)*100));
  btnZero.addEventListener("click", ()=> setGrams(0));
  btnToggle.addEventListener("click", ()=>{ answerHidden = !answerHidden; renderReadout(); });

  // init
  updateNeedleShape();
  setGrams(0);
})();
</script>
</body>
</html>